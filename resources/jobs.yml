variables:
  cluster_id:
    description: "Databricks cluster ID for job execution (required)"
  devs_group:
    description: "Group name for permissions (required)"

resources:
  jobs:
    snowflake_ingestion_job:
      name: "snowflake_ingestion_job"

      permissions: 
        - level: CAN_MANAGE_RUN
          group_name: ${var.devs_group}

        
      tasks:
        - task_key: snowflake_ingestion_task
          # Run on existing cluster configured via cluster_id variable
          existing_cluster_id: ${var.cluster_id}
          libraries:
            - whl: "../dist/*.whl"
          python_wheel_task:
            entry_point: snowpark-reader
            package_name: migration_accelerator_package
        
        - task_key: snowflake_ingestion_validation_task
          depends_on:
            - task_key: snowflake_ingestion_task
          existing_cluster_id: ${var.cluster_id}
          libraries:
            - whl: "../dist/*.whl"
          python_wheel_task:
            entry_point: snowflake-validator
            package_name: migration_accelerator_package
        
        - task_key: grant_flattening_task
          depends_on:
            - task_key: snowflake_ingestion_task
          existing_cluster_id: ${var.cluster_id}
          libraries:
            - whl: "../dist/*.whl"
          python_wheel_task:
            entry_point: grant-transformer
            package_name: migration_accelerator_package

        - task_key: artifact_translation_task
          depends_on:
            - task_key: grant_flattening_task
          existing_cluster_id: ${var.cluster_id}
          python_wheel_task:
            entry_point: translation-module
            package_name: migration_accelerator_package

        - task_key: migration_report_task
          depends_on:
            - task_key: artifact_translation_task
          existing_cluster_id: ${var.cluster_id}
          libraries:
            - whl: "../dist/*.whl"
          python_wheel_task:
            entry_point: migration-report
            package_name: migration_accelerator_package
              
      timeout_seconds: 3600
      max_concurrent_runs: 1