name: Deploy Migration Accelerator through Databricks Asset Bundles

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:

env:
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
  DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
  DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
  DATABRICKS_AUTH_TYPE: oauth-m2m
  POETRY_VERSION: "2.2.1"
  PYTHON_VERSION: "3.12"

jobs:
  deploy-bundle:
    runs-on: ubuntu-latest

    concurrency:
      group: deploy-app-dbx-job-executor-app-dev
      cancel-in-progress: true
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install pipx and Poetry
      run: |
        python -m pip install --upgrade pip pipx
        pipx install poetry==${{ env.POETRY_VERSION }}
        poetry --version
    
    - name: Install project dependencies
      run: |
        poetry install --no-interaction --no-ansi
    
    - name: Install Databricks CLI
      uses: databricks/setup-cli@main

    - name: Validate bundle
      run: |
        databricks bundle validate -t dev \
          --var="cluster_id=${{ secrets.DATABRICKS_CLUSTER_ID }}" \
          --var="catalog_name=${{ secrets.UC_CATALOG }}" \
          --var="devs_group=${{ secrets.DEVS_GROUP }}"

    - name: Deploy bundle
      run: |
        databricks bundle deploy -t dev \
          --var="cluster_id=${{ secrets.DATABRICKS_CLUSTER_ID }}" \
          --var="catalog_name=${{ secrets.UC_CATALOG }}" \
          --var="devs_group=${{ secrets.DEVS_GROUP }}"
        databricks bundle run databricks_job_executor_app -t dev 
        databricks bundle summary
        databricks bundle resources