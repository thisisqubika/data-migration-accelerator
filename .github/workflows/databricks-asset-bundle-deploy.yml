name: Deploy Migration Accelerator through Databricks Asset Bundles

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:

env:
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
  DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
  DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
  DATABRICKS_AUTH_TYPE: oauth-m2m
  POETRY_VERSION: "2.2.1"
  PYTHON_VERSION: "3.12"

jobs:
  deploy-bundle:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install pipx and Poetry
      run: |
        python -m pip install --upgrade pip pipx
        pipx install poetry==${{ env.POETRY_VERSION }}
        poetry --version
    
    - name: Install project dependencies
      run: |
        poetry install --no-interaction --no-ansi
    
    - name: Install Databricks CLI
      uses: databricks/setup-cli@main

    - name: Validate bundle
      run: |
        databricks bundle validate

    - name: Deploy bundle
      run: |
        databricks bundle deploy -t dev
        databricks bundle summary
        databricks bundle resources
    
    - name: Sync app source to workspace
      working-directory: databricks-migration-accelerator
      run: |
        WORKSPACE_PATH="/Workspace/Shared/databricks-job-executor"
        databricks workspace mkdirs "$WORKSPACE_PATH" || true
        databricks workspace import-dir . "$WORKSPACE_PATH" --overwrite

    - name: Deploy app
      working-directory: databricks-job-executor
      run: |
        databricks apps deploy dbx-job-executor-app --source-code-path /Workspace/Shared/databricks-job-executor
        databricks apps update dbx-job-executor-app --default-source-code-path /Workspace/Shared/databricks-job-executor || true